{{ 'promo-banner.css' | asset_url | stylesheet_tag }}
<div id="promo-banners">
  <!-- Banners will be injected here by JavaScript -->
</div>

<div class="promo-banners">
  {% for block in section.blocks %}
    {% if block.type == 'banner' %}
      {% assign discount_value = '15%' %}
      {% assign discount_code = block.settings.discount_code %}
      <div class="promo-banner" style="background-color: {{ block.settings.background_color }}; color: {{ block.settings.text_color }};">
        <p>{{ block.settings.message | replace: "[discount_code]", discount_code }} </p>
        <button class="close-banner" style="color: {{ block.settings.text_color }};">Close</button>
      </div>
    {% endif %}
  {% endfor %}

  {{ section.blocks }}
</div>
<script src="{{ 'promo-banner.js' | asset_url }}" defer="defer"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var promoBannersContainer = document.getElementById('promo-banners');
  
  // Sample data, replace with data from schema
  var banners = [
    {
      backgroundColor: '#ffcc00',
      textColor: '#000',
      message: 'Your 15% off discount code WELCOME15 will auto-apply at checkout.',
      utmMedium: 'social',
      discountCode: 'WELCOME15',
      createdAt: '2024-07-11T10:00:00Z'
    },
    {
      backgroundColor: '#00ccff',
      textColor: '#fff',
      message: 'Special offer for newsletter subscribers!',
      utmMedium: 'newsletter',
      discountCode: 'NEWSLETTER10',
      createdAt: '2024-07-10T09:00:00Z'
    }
    // Add more banners as needed
  ];

  function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
  }

  var utmMedium = getUrlParameter('utm_medium');
  var discountCode = getUrlParameter('discount');

  var matchedBanners = banners.filter(function(banner) {
    return banner.utmMedium === utmMedium || banner.discountCode === discountCode;
  });

  if (matchedBanners.length > 0) {
    // Sort matched banners by creation date to show the most recent one
    matchedBanners.sort(function(a, b) {
      return new Date(b.createdAt) - new Date(a.createdAt);
    });

    var mostRecentBanner = matchedBanners[0];

    var promoBanner = document.createElement('div');
    promoBanner.style.backgroundColor = mostRecentBanner.backgroundColor;
    promoBanner.style.color = mostRecentBanner.textColor;
    promoBanner.innerHTML = '<p>'+mostRecentBanner.message+'</p><button class="close-banner">Close</button>';
    promoBannersContainer.appendChild(promoBanner);

    promoBanner.style.display = 'block';

    

    var closeButton = promoBanner.querySelector('.close-banner');
    closeButton.addEventListener('click', function() {
      promoBanner.style.display = 'none';
      localStorage.setItem('promoBannerDismissed_'+mostRecentBanner.createdAt, 'true');
    });

    if (localStorage.getItem('promoBannerDismissed_'+mostRecentBanner.createdAt) !== 'true') {
      promoBanner.style.display = 'block';
    }
  }
});
</script>


{% schema %}
{
  "name": "Promo Banners",
  "settings": [],
  "blocks": [
    {
      "type": "banner",
      "name": "Banner",
      "settings": [
        {
          "type": "color",
          "id": "background_color",
          "label": "Background color"
        },
        {
          "type": "color",
          "id": "text_color",
          "label": "Text color"
        },
        {
          "type": "text",
          "id": "message",
          "label": "Message",
          "info": "E.g Your [discount_value]% off discount code [discount_code] will auto-apply at checkout."
        },
        {
          "type": "text",
          "id": "utm_medium",
          "label": "UTM Medium"
        },
        {
          "type": "text",
          "id": "discount_code",
          "label": "Discount code"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Default",
      "category": "Banners"
    }
  ]
}
{% endschema %}